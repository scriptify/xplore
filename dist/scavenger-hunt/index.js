"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}var USER_PROGRESS_KEY="user-progress";function saveProgress(a,b){console.log("save progress",b),localStorage.setItem(USER_PROGRESS_KEY,JSON.stringify({currentHintId:a,status:b}))}function loadJSONFile(a){return fetch(a).then(function(a){return a.json()})}function _scanQR(a){return new Promise(/*#__PURE__*/function(){var b=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function b(c,d){var e,f,g;return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return e=document.querySelector(a),e.style.display="block",f=new Instascan.Scanner({video:e,mirror:!1}),f.addListener("scan",/*#__PURE__*/function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(b){var d;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:try{d=parseInt(b)}catch(a){c(-1)}// Hide again
return e.style.display="none",a.next=4,f.stop();case 4:c(d);case 5:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()),b.prev=4,b.next=7,Instascan.Camera.getCameras();case 7:if(g=b.sent,0!==g.length){b.next=11;break}return d(),b.abrupt("return");case 11:return b.next=13,f.start(g[g.length-1]);case 13:b.next=19;break;case 15:return b.prev=15,b.t0=b["catch"](4),d(b.t0),b.abrupt("return");case 19:case"end":return b.stop();}},b,this,[[4,15]])}));return function(){return b.apply(this,arguments)}}())}var ScavengerHunt=/*#__PURE__*/function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},c=b.onShowPlaceInformation,d=void 0===c?function(){}:c,e=b.onShowHint,f=void 0===e?function(){}:e,g=b.onNotify,h=void 0===g?function(){}:g,i=b.qrCameraContainer,j=void 0===i?"#app":i,k=b.waitForBtnClick,l=b.dataFolder,m=void 0===l?"data":l;_classCallCheck(this,a),this.onShowPlaceInformation=d,this.onShowHint=f,this.qrCameraContainer=j,this.waitForBtnClick=k,this.onNotify=h,this.dataFolder=m;var n="".concat(m,"/meta.json");this.setup(n)}return _createClass(a,[{key:"setup",value:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(b){var c,d;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(c=JSON.parse(localStorage.getItem(USER_PROGRESS_KEY)),!(c&&c.currentHintId)){a.next=5;break}this.scavengerHunt({jsonPath:"".concat(this.dataFolder,"/").concat(c.currentHintId,".json"),initialStatus:c.status}),a.next=9;break;case 5:return a.next=7,loadJSONFile(b);case 7:d=a.sent,this.scavengerHunt({jsonPath:d.entryHint});case 9:case"end":return a.stop();}},a,this)}));return function b(){return a.apply(this,arguments)}}()},{key:"showWelcome",value:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(b){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return this.onShowPlaceInformation(b.placeInformation),a.next=3,this.waitForBtnClick();case 3:this.scavengerHunt({jsonPath:"".concat(this.dataFolder,"/").concat(b.nextHint,".json")});case 4:case"end":return a.stop();}},a,this)}));return function b(){return a.apply(this,arguments)}}()},{key:"showHint",value:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(b){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return saveProgress(b.id,"hint"),this.onShowHint(b.hint),a.next=4,this.waitForBtnClick();case 4:case"end":return a.stop();}},a,this)}));return function b(){return a.apply(this,arguments)}}()},{key:"scanQR",value:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(b){var c;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=null,a.prev=1,a.next=4,_scanQR(this.qrCameraContainer);case 4:c=a.sent,a.next=11;break;case 7:return a.prev=7,a.t0=a["catch"](1),this.onNotify({title:"Camera error",content:"\n          Was not able to access the device camera.\n          You must accept the according dialog.\n          Maybe your device doesn't support camera access.\n        ",btnContent:"Reload",action:function a(){return window.location.reload()}}),a.abrupt("return");case 11:if(c!==b.id){a.next=15;break}return a.abrupt("return",!0);case 15:return a.abrupt("return",!1);case 16:case"end":return a.stop();}},a,this,[[1,7]])}));return function b(){return a.apply(this,arguments)}}()},{key:"scavengerHunt",value:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(b){var c,d,e,f,g,h,i=this;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=b.jsonPath,d=b.initialStatus,e=void 0===d?"hint":d,a.next=3,loadJSONFile(c);case 3:if(f=a.sent,g=/*#__PURE__*/function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return i.onShowPlaceInformation(f.placeInformation),saveProgress(f.id,"placeInfo"),a.next=4,i.waitForBtnClick();case 4:f.nextHint?i.scavengerHunt({jsonPath:"".concat(i.dataFolder,"/").concat(f.nextHint,".json")}):i.onNotify({title:"Congrats!",content:"You arrived at the end of this scavenger hunt!"});case 5:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}(),"placeInfo"!==e){a.next=9;break}return a.next=8,g();case 8:return a.abrupt("return");case 9:if(f.hint){a.next=14;break}return a.next=12,this.showWelcome(f);case 12:a.next=26;break;case 14:return a.next=16,this.showHint(f);case 16:return a.next=18,this.scanQR(f);case 18:if(h=a.sent,!h){a.next=23;break}g(),a.next=26;break;case 23:return a.next=25,this.onNotify({title:"Wrong QR",content:"This is the wrong QR code. Keep searching for the correct one!"});case 25:this.scavengerHunt({jsonPath:c});case 26:case"end":return a.stop();}},a,this)}));return function b(){return a.apply(this,arguments)}}()}]),a}();